{% extends "layout.html" %}

{% block title %}
    Add contribution: "{{info.title}}"
{% endblock %}

{% block main %}
        <h2>Add a contribution</h2>
        <em>The category of this piece is <b>{{info.category}}</b>.<br> You can add up to <b>{{info.max_units}} {{info.max_unit_type}}</b>.</em>
        <form action="/add-contribution/{{info.id}}" method="post">

            <textarea id="contribution-textarea" name="contribution" rows="10" required class="readonly-part">{{current_text}}</textarea>
            <input type="hidden" id="protected-length" value="{{ current_text | length }}">
            <br>

            <button type="submit" name="action" value="contribute" class="custom-button-colour">Submit contribution</button>
            {% if info.creator_id == session["user_id"] and not info.is_completed %}
                <button type="submit" name="action" value="complete" class="custom-button-colour">Mark as completed</button>
            {% endif %}
        </form>

<script>
    // Following script assisted by ChatGPT

    const textarea = document.getElementById("contribution-textarea");
    const protectedLength = parseInt(document.getElementById("protected-length").value);

    // Force cursor to end on focus
    textarea.addEventListener("focus", () => {
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    });

    textarea.addEventListener("keydown", (e) => {
        const cursorPos = textarea.selectionStart;

        // Allow navigation keys
        const allowedKeys = [
            "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown",
            "Shift", "Control", "Alt", "Meta", "Tab"
        ];

        if (allowedKeys.includes(e.key)) return;

        // Block deletion in protected area
        if (
            cursorPos <= protectedLength &&
            (e.key === "Backspace" || e.key === "Delete")
        ) {
            e.preventDefault();
            return;
        }

        // Block typing before protected text
        if (cursorPos < protectedLength) {
            e.preventDefault();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    });

    textarea.addEventListener("paste", (e) => {
        if (textarea.selectionStart < protectedLength) {
            e.preventDefault();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    });
</script>

{% endblock %}
